export const parseApiError = (err, fallback = '服务异常，请稍后再试') => {
  const code = extractCode(err)
  const codeMsg = mapCodeToMessage(err)
  if (codeMsg) return codeMsg
  if (err?.response?.data?.message) return err.response.data.message
  if (err?.message) return err.message
  return fallback
}

export const extractCode = (err) => err?.response?.data?.code

const codeMessages = {
  // 通用
  40001: '错误的请求',
  40002: '请求参数不合法',
  40400: '资源不存在',
  40900: '资源冲突',
  40910: '当前状态不允许执行该操作',
  40911: '资源被占用，请稍后重试',
  42900: '请求过于频繁，请稍后再试',

  // 认证 / 授权
  40100: '认证失败',
  40101: '用户名或密码错误',
  40102: '登录状态已失效，请重新登录',
  40103: '账户失效，请联系管理员',
  40104: '验证码错误或已过期',
  40105: '邮箱未验证，请先完成邮箱验证',
  40106: '账户已被封禁，暂无法登录',
  40300: '无权限进行该操作',
  40301: '未报名当前比赛，无法访问',
  40302: '私有资源，权限不足',
  40303: '封榜期间或已结束，暂不可访问',

  // 比赛相关（46xxx）
  46000: '比赛相关错误',
  46001: '比赛尚未开始，当前不可提交',
  46002: '比赛已结束，提交不再计分',
  46003: '比赛因特殊原因已冻结',
  46004: '比赛未发布或不可见',
  46005: '当前比赛未开启组队功能',
  46006: '当前时间不可加入比赛或队伍',
  46007: '比赛封榜期间暂不支持该操作',

  // 队伍相关（47xxx）
  47000: '队伍相关错误',
  47001: '你已加入其他队伍，不能重复加入',
  47002: '队伍人数已满，无法加入',
  47003: '你不是该队伍成员，不能进行此操作',
  47004: '队伍已解散，无法继续操作',
  47005: '仅队长可执行该操作',
  47006: '队伍邀请码无效，请联系队长重新获取',

  // 账户相关（4095x）
  40950: '账户相关错误',
  40951: '账户ID分配已达上限，无法创建新用户',
  40952: '邮箱验证码错误或已失效',
  40953: '该邮箱已被绑定，请更换邮箱',
  40954: '账户已注销，无法完成该操作',

  // 题目 / Flag 相关（48xxx）
  48000: '题目相关错误',
  48001: '当前题目暂不可用',
  48002: '该题已解出，无需重复提交',
  48003: '当前比赛未包含该题目',
  48004: '题目未发布或不可见',
  48005: '提示未解锁，暂不可查看',
  48006: '附件不可访问',
  48010: 'Flag 提交相关错误',
  48011: 'Flag 格式不正确',
  48012: 'Flag 不正确，请继续努力',

  // 提交相关（481xx）
  48100: '提交相关错误',
  48101: '封榜期间暂不允许提交',
  48102: '提交过于频繁，请稍后再试',

  // 靶机相关（49xxx）
  49000: '靶机相关错误',
  49001: '已有运行中的靶机实例，请勿重复创建',
  49002: '靶机端口分配失败，请稍后重试',
  49003: '靶机实例数量已达上限',
  49004: '靶机镜像不存在，请联系管理员',
  49005: '启动过于频繁，请稍后再试',

  // 基础设施 / 依赖（503xx）
  50300: '系统服务暂时不可用，请稍后重试',
  50301: '缓存服务暂时不可用，请稍后重试',
  50302: '消息队列暂时不可用，请稍后重试',
  50303: '文件存储服务暂时不可用，请稍后重试',
  50304: '邮件发送失败，请稍后重试',
}

export const mapCodeToMessage = (err) => {
  const code = extractCode(err)
  if (code && codeMessages[code]) return codeMessages[code]
  return ''
}
